<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> SLAE64 - Assignment 3 - EggHunter | Andrea Perfetti</title>
  <meta name="description" content="YHQL, YLGL, YLFL.">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="SLAE64 - Assignment 3 - EggHunter" />
<meta property="og:description" content="The third assigment for the SLAE64 certification asks to study about the EggHunter shellcode and to create a working demo of it.
Egg Hunting (tl;dr) The most basic Buffer Overflow exploit technique consists of creating a string that contains garbage bytes, a memory address to be overwritten on the return address (which will be popped into EIP during the ret procedure) and some shellcode to be then executed, being invoked via a JMP ESP." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://andrea-perfetti.github.io/posts/slae64-exam/2021-04-05-slae64-assignment-3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-05T00:00:00&#43;00:00" />
<meta property="article:modified_time" content="2021-04-05T00:00:00&#43;00:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SLAE64 - Assignment 3 - EggHunter"/>
<meta name="twitter:description" content="The third assigment for the SLAE64 certification asks to study about the EggHunter shellcode and to create a working demo of it.
Egg Hunting (tl;dr) The most basic Buffer Overflow exploit technique consists of creating a string that contains garbage bytes, a memory address to be overwritten on the return address (which will be popped into EIP during the ret procedure) and some shellcode to be then executed, being invoked via a JMP ESP."/>

  
  
    
  
  
  <link rel="stylesheet" href="https://andrea-perfetti.github.io/css/style-white.css">
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://andrea-perfetti.github.io/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

  <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About me</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li>
          <a class="icon" href=" https://andrea-perfetti.github.io/posts/slae64-exam/2021-04-04-slae64-assignment-2/">
            <i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i>
          </a>
        </li>
        
        
        <li>
          <a class="icon" href="https://andrea-perfetti.github.io/posts/slae64-exam/2021-04-05-slae64-assignment-1/">
            <i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i>
          </a>
        </li>
        
        <li>
          <a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
            <i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i>
          </a>
        </li>
        <li>
          <a class="icon" href="#">
            <i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i>
          </a>
        </li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f">
      <i class="fab fa-facebook " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&text=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-twitter " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-linkedin " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&is_video=false&description=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-pinterest " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=SLAE64%20-%20Assignment%203%20-%20EggHunter&body=Check out this article: https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f">
      <i class="fas fa-envelope " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-get-pocket " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-reddit " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-stumbleupon " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-digg " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&name=SLAE64%20-%20Assignment%203%20-%20EggHunter&description=The%20third%20assigment%20for%20the%20SLAE64%20certification%20asks%20to%20study%20about%20the%20EggHunter%20shellcode%20and%20to%20create%20a%20working%20demo%20of%20it.%0aEgg%20Hunting%20%28tl%3bdr%29%20The%20most%20basic%20Buffer%20Overflow%20exploit%20technique%20consists%20of%20creating%20a%20string%20that%20contains%20garbage%20bytes%2c%20a%20memory%20address%20to%20be%20overwritten%20on%20the%20return%20address%20%28which%20will%20be%20popped%20into%20EIP%20during%20the%20ret%20procedure%29%20and%20some%20shellcode%20to%20be%20then%20executed%2c%20being%20invoked%20via%20a%20JMP%20ESP.">
      <i class="fab fa-tumblr " aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&t=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-hacker-news " aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>
    <div id="toc">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#egg-hunting-tldr">Egg Hunting (tl;dr)</a></li>
    <li><a href="#egghunter-shellcode">EggHunter shellcode</a></li>
  </ul>
</nav>
    </div>
  </span>
</div>


  <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
    <header>
      <h1 class="posttitle" itemprop="name headline">
        SLAE64 - Assignment 3 - EggHunter
      </h1>
      <div class="meta">
        
        <div class="postdate">
          
          <time datetime="2021-04-05 00:00:00 &#43;0000 UTC" itemprop="datePublished">2021-04-05</time>
          
        </div>
        
        <div class="article-category">
            <i class="fas fa-archive"></i>
            
            
            <a class="category-link" href="/categories/slae64-exam-assignments">SLAE64 Exam Assignments</a>
            
        </div>
        
        
        <div class="article-tag">
            <i class="fas fa-tag"></i>
            
            
            <a class="tag-link" href="/tags/slae64" rel="tag">SLAE64</a>
            
        </div>
        
      </div>
    </header>

  
    <div class="content" itemprop="articleBody">
      <p>The third assigment for the SLAE64 certification asks to study about the <em>EggHunter</em> shellcode and to create a working demo of it.</p>
<h2 id="egg-hunting-tldr">Egg Hunting (tl;dr)</h2>
<p>The most basic Buffer Overflow exploit technique consists of creating a string that contains garbage bytes, a memory address to be overwritten on the return address (which will be popped into EIP during the <code>ret</code> procedure) and some shellcode to be then executed, being invoked via a JMP ESP.</p>
<p>This is a conceptual representation of the payload, where section &lsquo;A&rsquo; contains garbage bytes, section &lsquo;B&rsquo; the memory address of a suitable instruction to redirect the execution flow to the section &lsquo;C&rsquo;:
<img src="/img/slae/slae3-bof-concept.png" alt="Buffer Overflow payload basic representation"></p>
<p>It is all working in the concept, but what happens if the &lsquo;C&rsquo; section is too small to contain the intended shellcode? What if we could place our complete shellcode in other memory sections and then search for it and execute it?<br>
This is the exact purpose of the EggHunting technique:</p>
<ul>
<li>to put the complete shellcode somewhere in the process memory area (even in the &lsquo;A&rsquo; section) prefixing it with an &lsquo;egg&rsquo; - simply, a marker - repeated two-times (to ensure uniqueness)</li>
<li>to create a very short shellcode - the <em>Egg Hunter</em> itself - to find the double-egg in memory and then redirect the execution flow just right after it.</li>
</ul>
<p><img src="/img/slae/slae3-bof-egghunter-concept.png" alt="Buffer Overflow egghunting basic representation"></p>
<h2 id="egghunter-shellcode">EggHunter shellcode</h2>
<p>Skape&rsquo;s paper &ldquo;<a href="http://www.hick.org/code/skape/papers/egghunt-shellcode.pdf">Safely Searching Process Virtual Address Space</a>&rdquo; can be easily defined as both the <em>blueprint</em> and the <em>masterpiece</em> of Egg Hunting. This document presents three different implementations of EggHunter shellcode for Linux and three implementations for Windows.</p>
<p>The EggHunting shellcode leverages the <a href="https://man7.org/linux/man-pages/man2/access.2.html">access()</a> syscall. For each memory page, the shellcode tries accessing the address; if 0xF2 error is returned (EFAULT) it means that the pointer is outside the accessible address space, and therefore it goes to the next page; if page is accessible, addresses are scanned in order to find the egg (0xDEADBEEF in the shellcode) repeated twice.
When it is found, the address of the start of the shellcode is contained into register RDI and therefore a jump to RDI is performed.</p>
<p>In order to test the correct execution, I have added a &ldquo;jmp_to_egg&rdquo; label just right before the jump to the shellcode found after the egg, and an appropriate breakpoint has been added:
<img src="/img/slae64/3-egghunter-1-functionsbreaks.png" alt="EggHunter - GDB - Breakpoint"></p>
<p>When the breakpoint is reached, it means that the egg has been found - repeated two times - in memory.
<img src="/img/slae64/3-egghunter-2-breakreached.png" alt=""></p>
<p>As expected, the next instruction will be a <code>jmp rdi</code>:
<img src="/img/slae64/3-egghunter-disas.png" alt=""></p>
<p>Looking at the value in the register RDI, we see that in the execution it is <code>0x4000b0</code>. Given that the shellcode (label &lsquo;Shellcode&rsquo;) starts at <code>0x4000a8</code> and the first 8 bytes are the two copies of the egg, it means that <code>0x4000b0</code> is the start address of the actual shellcode right after the eggs.
<img src="/img/slae64/3-egghunter-variables.png" alt=""></p>
<p>Running the compiled (remember that Stack has to be marked as executable, therefore I used the &lsquo;compileExec.sh&rsquo; utility) program in the terminal it behaves as expected, i.e. exits with status code 13:
<img src="/img/slae64/3-egghunter-poc1.png" alt=""></p>
<p>I created another version of the same program, under <code>/Test2/</code> directory: it is exactly the same except for the shellcode, which is at the top of the &lsquo;.text&rsquo; section instead of the &lsquo;.data&rsquo; section. It behaves in the same exact way:
<img src="/img/slae64/3-egghunter-poc2.png" alt=""></p>
<!-- raw HTML omitted -->
<hr>
<p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification: <a href="http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html">http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html</a>.</p>
<p><strong>Student ID</strong>: <code>PA-29059</code><br>
<strong>GitHub repository</strong>: <a href="https://github.com/andrea-perfetti/SLAE64-Exam">https://github.com/andrea-perfetti/SLAE64-Exam</a></p>
<p>This assignment has been written on a Kali Linux 2021.1 64-bit virtual machine:</p>
<pre><code>┌──(kali㉿kali)-[~]
└─$ uname -a
Linux kali 5.10.0-kali3-amd64 #1 SMP Debian 5.10.13-1kali1 (2021-02-08) x86_64 GNU/Linux
</code></pre>
    </div>
  </article>

  
  





  <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/posts">Posts</a></li>
         
          <li><a href="/tags">Tags</a></li>
         
          <li><a href="/about">About me</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#egg-hunting-tldr">Egg Hunting (tl;dr)</a></li>
    <li><a href="#egghunter-shellcode">EggHunter shellcode</a></li>
  </ul>
</nav>
    </div>

    <div id="share-footer" style="display: none">
      
      <ul>
  
  
    
  
  
  <li>
    <a class="icon" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f">
      <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://twitter.com/share?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&text=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-linkedin fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&is_video=false&description=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-pinterest fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="mailto:?subject=SLAE64%20-%20Assignment%203%20-%20EggHunter&body=Check out this article: https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f">
      <i class="fas fa-envelope fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://getpocket.com/save?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://reddit.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-reddit fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.stumbleupon.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://digg.com/submit?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&title=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-digg fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="http://www.tumblr.com/share/link?url=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&name=SLAE64%20-%20Assignment%203%20-%20EggHunter&description=The%20third%20assigment%20for%20the%20SLAE64%20certification%20asks%20to%20study%20about%20the%20EggHunter%20shellcode%20and%20to%20create%20a%20working%20demo%20of%20it.%0aEgg%20Hunting%20%28tl%3bdr%29%20The%20most%20basic%20Buffer%20Overflow%20exploit%20technique%20consists%20of%20creating%20a%20string%20that%20contains%20garbage%20bytes%2c%20a%20memory%20address%20to%20be%20overwritten%20on%20the%20return%20address%20%28which%20will%20be%20popped%20into%20EIP%20during%20the%20ret%20procedure%29%20and%20some%20shellcode%20to%20be%20then%20executed%2c%20being%20invoked%20via%20a%20JMP%20ESP.">
      <i class="fab fa-tumblr fa-lg" aria-hidden="true"></i>
    </a>
  </li>
  <li>
    <a class="icon" href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fandrea-perfetti.github.io%2fposts%2fslae64-exam%2f2021-04-05-slae64-assignment-3%2f&t=SLAE64%20-%20Assignment%203%20-%20EggHunter">
      <i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i>
    </a>
  </li>
</ul>

    </div>

    <div id="actions-footer">
      
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;">
          <i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;">
          <i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;">
          <i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');">
          <i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>


  <footer id="footer">
  <div class="footer-left">
    Copyright  &copy; 2021  Andrea Perfetti 
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
        <li><a href="/">Home</a></li>
         
        <li><a href="/posts">Posts</a></li>
         
        <li><a href="/tags">Tags</a></li>
         
        <li><a href="/about">About me</a></li>
        
      </ul>
    </nav>
  </div>
</footer>


  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>



</html>
